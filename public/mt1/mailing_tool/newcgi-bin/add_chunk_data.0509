#!/usr/bin/perl
# *****************************************************************************************
# add_chunk_data.pl
#
# History
# Jim Sobeck, 04/07/06, Creation
# *****************************************************************************************

use strict;
use lib "/var/www/html/newcgi-bin";
use util;

my $util = util->new;
my $sth;
my $list_id;
my $sth1;
my $sth1a;
my $sth2;
my $del_cnt;
my ($camp_id,$aol_comp,$bounce_cnt,$fullmbx_cnt,$uns_cnt,$notdelivered_cnt);
my $dbh;
my $from_addr;
my $sql;
my $rows;
my $cdate = localtime();
my $amount_to_add;
my $aolflag;
my $hotmailflag;
my $otherflag;
my $yahooflag;
my $client_id;
my $profile_id;
my $profile_name;


# connect to the util database

$| = 1;

$util->db_connect();
$dbh = $util->get_dbh;

$sql = "select list_profile.profile_id,profile_name,client_id,amount_to_add,list_profile.aol_flag,list_profile.hotmail_flag,list_profile.other_flag,list_profile.yahoo_flag from list_profile,campaign where profile_type='CHUNK' and amount_to_add > 0 and list_profile.profile_id=campaign.profile_id and scheduled_datetime >= curdate() and scheduled_datetime < date_add(curdate(),interval 1 day) and deleted_date is null and campaign.status='S' and (date_added < curdate() or date_added is null)";
$sth1 = $dbh->prepare($sql);
$sth1->execute();
while (($profile_id,$profile_name,$client_id,$amount_to_add,$aolflag,$hotmailflag,$otherflag,$yahooflag) = $sth1->fetchrow_array())
{
	my $lrDomIDsIN=[];
	my $lrDomIDsNOTIN=[];
	for (my $i=1; $i <= 3; $i++) 
	{
		my $qSelDom=qq^SELECT domain_id FROM email_domains WHERE domain_class=?^;
		my $sthDom=$dbh->prepare($qSelDom);
		$sthDom->execute($i);
		while (my ($domID)=$sthDom->fetchrow) 
		{
			if ($i == 1) 
			{
				push @$lrDomIDsIN, $domID if $aolflag eq 'Y' && $otherflag eq 'N';
				push @$lrDomIDsNOTIN, $domID if $aolflag eq 'N' && $otherflag eq 'Y';
			}
			elsif ($i == 2) 
			{
				push @$lrDomIDsIN, $domID if $hotmailflag eq 'Y' && $otherflag eq 'N';
				push @$lrDomIDsNOTIN, $domID if $hotmailflag eq 'N' && $otherflag eq 'Y';
			}
			else 
			{
				push @$lrDomIDsIN, $domID if $yahooflag ne 'N' && $otherflag eq 'N';
				push @$lrDomIDsNOTIN, $domID if $yahooflag eq 'N' && $otherflag eq 'Y';
			}
		}
		$sthDom->finish;
	}
			
	my $in_domain_sql=join(', ', @$lrDomIDsIN);
	my $nin_domain_sql=join(', ', @$lrDomIDsNOTIN);
#
#	If aolflag then check complaints
#
	$sql = "select campaign_id,aol_complaints,bounce_cnt,fullmbx_cnt,unsubscribe_cnt,notdelivered_cnt from campaign where profile_id=$profile_id and sent_datetime = date_sub(curdate(),interval 1 day)";
	$sth = $dbh->prepare($sql);
	$sth->execute();
	while (($camp_id,$aol_comp,$bounce_cnt,$fullmbx_cnt,$uns_cnt,$notdelivered_cnt) = $sth->fetchrow_array())
	{
		if ($aol_comp > 0)
		{
			$sql="select sum(sent_cnt)-$bounce_cnt-$fullmbx_cnt-$notdelivered_cnt from campaign_log where campaign_id=$camp_id";
			$sth1a = $dbh->prepare($sql);
			$sth1a->execute();
			($del_cnt) = $sth1a->fetchrow_array();
			$sth1a->finish();
			my $del_percent;
			if ($del_cnt > 0)
			{
				$del_percent = ($aol_comp / $del_cnt)*100;
			}
			else
			{
				$del_percent = 0; 
			}
			if ($del_percent > 1)
			{
				print "$del_cnt - $aol_comp - $profile_name\n";
				$amount_to_add=0;
			}
		}
		else
		{
			$sql="select sum(sent_cnt) from campaign_log where campaign_id=$camp_id";
			$sth1a = $dbh->prepare($sql);
			$sth1a->execute();
			($del_cnt) = $sth1a->fetchrow_array();
			$sth1a->finish();
			if ($del_cnt > 1000)
			{
				print "No AOL Complaints for $profile_id - $profile_name\n";
				$amount_to_add=0;
			}
		}
	}
	$sth->finish();
	if ($amount_to_add > 0)
	{
		$sql="select list_id from list_profile_list where profile_id=$profile_id";
		print "Sql <$sql>\n";
		$sth = $dbh->prepare($sql);
		$sth->execute();
		while (($list_id) = $sth->fetchrow_array())
		{
			print "Adding $amount_to_add records to client $client_id for profile $profile_id - $list_id\n";
			$sql="update email_chunk_list_${client_id} set list_id=$list_id,subscribe_date=curdate() where list_id=0 and status='A' "; 
			$sql.=qq^ AND domain_id IN ($in_domain_sql)^ if $in_domain_sql;
			$sql.=qq^ AND domain_id NOT IN ($nin_domain_sql)^ if $nin_domain_sql;
			$sql = $sql . " order by email_user_id limit $amount_to_add";
	unless ($dbh && $dbh->ping) {
	$util->db_connect();
	$dbh = $util->get_dbh;
	}
			$rows = $dbh->do($sql);
		}
		$sth->finish();
		$sql="update list_profile set date_added=curdate() where profile_id=$profile_id";
	unless ($dbh && $dbh->ping) {
	$util->db_connect();
	$dbh = $util->get_dbh;
	}
		$rows = $dbh->do($sql);
	}
}
$sth1->finish();
$util->clean_up();
exit(0);
